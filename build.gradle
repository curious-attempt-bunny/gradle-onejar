apply plugin: 'groovy'
apply plugin: 'eclipse'

repositories {
	mavenCentral()
}

dependencies {
	groovy 'org.codehaus.groovy:groovy-all:1.7.6'
}

sourceSets {
	thirdparty {
		java {
			srcDir 'src/thirdparty/java'	
		}
	}
}

task exampleOneJar(type: OneJar, dependsOn: jar) {
	mainClass = 'com.curiousattemptbunny.onejar.ExampleMain'
}

artifacts {
  archives exampleOneJar
}

apply plugin: 'java'
class OneJar extends Jar {
	String mainClass
	def runtime
	def jar
	
	OneJar() {
		def oneJarClasses = project.sourceSets.thirdparty.classes
		jar = project.tasks.jar
		runtime = project.configurations.runtime
		
		def jar = project.tasks.jar
			
		configure {
			appendix = 'onejar'
			manifest {
			    	attributes  'Created-By':'Gradle OneJar task',
					    'Main-Class':'com.simontuffs.onejar.Boot'
			}
		
			from oneJarClasses
		
			into('lib') {
				from runtime	
			}
		
			into('main') {
				from jar.archivePath
				rename { 'main.jar' }
			}
		}
	}

	public void setMainClass(String mainClass) {
		this.mainClass = mainClass
		configure {
			manifest {
				attributes 'One-Jar-Main-Class': mainClass
			}
		}	
	}
}
